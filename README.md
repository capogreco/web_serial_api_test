# Monome Grid Web Serial API Test

This project demonstrates how to connect to a Monome Grid using the Web Serial API and Web Audio API. It implements the Monome Serial Protocol for full control of the grid.

> This code was generated by Claude (Anthropic) under the instruction of @capogreco.

## Features

- Connect to a Monome Grid device via the Web Serial API
- Visual grid representation in the browser
- Bi-directional communication with the device:
  - Send LED on/off commands
  - Send row, column, and map (8x8 block) commands
  - Control LED intensity levels
  - Receive button press/release events
- Play tones using Web Audio API when buttons are pressed
- Interactive test pattern to visualize the connection
- Deno application for testing grid connections via serialosc
- CLI tool for debugging and monitoring Monome Grid serial communication

## Requirements

- A Chromium-based browser that supports the Web Serial API (Chrome, Edge, Opera)
- A Monome Grid device (monome grid 64/128/256)
- Local web server (optional, but recommended)

## Setup Instructions

1. Make sure serialosc not running in the background
   - on macOS, you can use: `brew services stop serialosc`
2. Connect your Monome Grid to your computer via USB
3. Host these files on a local web server with
   - `deno task start`
4. Open the webpage in a Chrome-based browser
5. Click the "Connect to Monome Grid" button
6. Select your Monome Grid from the serial port list (typically shows as a USB Serial device)
7. Start interacting with the grid!

## Note

Web Serial API will not work if serialosc is running in the background.

On macOS, use:

- `brew services stop serialosc`
- `brew services start serialosc`

... to stop and start serialosc, respectively.

## Technical Details

### Monome Serial Protocol

This implementation uses the complete Monome Serial Protocol:

#### System Commands
- Query Device: `[0x00]`
- Get Device ID: `[0x01]`
- Get Grid Size: `[0x05]`

#### LED Commands
- Set LED Off: `[0x10, x, y]`
- Set LED On: `[0x11, x, y]`
- Set All LEDs Off: `[0x12]`
- Set All LEDs On: `[0x13]`
- Set LED Map (8x8 block): `[0x14, x, y, data[8]]`
- Set LED Row: `[0x15, x, y, data]`
- Set LED Column: `[0x16, x, y, data]`
- Set LED Intensity: `[0x17, level]`
- Set LED Level: `[0x18, x, y, level]`

#### Key Grid Responses
- Key Up: `[0x20, x, y]`
- Key Down: `[0x21, x, y]`

### Web Serial API

The Web Serial API is used to communicate with the Monome Grid over USB. Configuration:

- Baud rate: 115200
- Data bits: 8
- Stop bits: 1
- Parity: None
- Buffer size: 64KB

### Web Audio API

The project uses the Web Audio API to generate tones when buttons are pressed:

- X-axis position maps to frequency using a pentatonic scale
- Y-axis position maps to note duration
- Simple envelope with attack and release for pleasant tones

## Usage Examples

### Controlling LEDs

```javascript
// Set a single LED on
await setLED(x, y, 1);

// Set a single LED off
await setLED(x, y, 0);

// Clear the entire grid
await clearGrid();

// Fill the entire grid
await fillGrid();

// Set a row of LEDs (more efficient)
await setLEDRow(x, y, bitmask);

// Set an 8x8 block of LEDs (most efficient)
await setLEDMap(x, y, [byte1, byte2, byte3, byte4, byte5, byte6, byte7, byte8]);
```

### Creating Patterns

The test pattern shows how to create animations:

```javascript
// Create a chasing light effect around the border
for (let i = 0; i < borderPositions.length; i++) {
    // Turn on an LED
    await setLED(pos.x, pos.y, 1);
    
    // Small delay
    await new Promise(resolve => setTimeout(resolve, 50));
    
    // Turn off the LED
    await setLED(pos.x, pos.y, 0);
}
```

## Troubleshooting

- **Port not found**: Make sure your Monome Grid is connected and powered on
- **Permission denied**: Try reconnecting your grid or restarting your browser
- **No response from device**: Check the serial configuration (baud rate, etc.)
- **No sound**: Click elsewhere on the page first to allow audio context creation
- **Button presses not detected**: See the "Known Issues and Solutions" section below

## Known Issues and Solutions

### Button Press Detection Issue

**Problem:** The grid buttons may not register when pressed. This issue occurs because the button detection logic depends on a serial read loop that might not start correctly.

**Root cause:** The issue was in the `setupReader()` function, which had a dependency on the `serialActive` flag, but this flag wasn't set to `true` until after the function was called in the connection sequence. This caused the reader to exit prematurely before it could detect any button presses.

**Solution:** The code has been modified to:

1. Start the reader immediately without waiting for the `serialActive` flag
2. Use a non-blocking approach with `setTimeout` for the reading loop
3. Only use `serialActive` for determining when to stop the loop, not when to start it

```javascript
// Non-blocking approach for reading serial data
async function readInBackground() {
    // Function to perform a single read operation
    async function performRead() {
        if (!reader) return false;
        
        try {
            const { value, done } = await reader.read();
            
            if (done) {
                console.log('Reader done - port closed or canceled');
                return false;
            }
            
            // Process the data if we got something
            if (value && value.length > 0) {
                processIncomingData(value);
            }
            
            return true; // Continue reading
        } catch (error) {
            console.error('Error reading from serial port:', error);
            return false; // Stop reading on error
        }
    }
    
    // Use setTimeout for non-blocking operation
    function scheduleNextRead() {
        setTimeout(async () => {
            if (await performRead() && serialActive) {
                scheduleNextRead();
            } else {
                // Clean up when stopping
                if (reader) {
                    reader.releaseLock();
                    reader = null;
                }
            }
        }, 10); // Small delay between reads
    }
    
    // Start the reading process
    scheduleNextRead();
}
```

This approach ensures that the reader starts immediately when the serial port is opened, allowing the application to detect button presses from the grid as soon as the connection is established.

### Web Worker Implementation for Serial Data Processing

We've further improved the serial reading implementation by moving the data processing to a Web Worker:

**Problem:** Even with the non-blocking setTimeout approach, processing serial data on the main thread can impact UI performance, especially with high data volumes.

**Solution:** We've implemented a multi-threaded approach:

1. Create a dedicated `serial-worker.js` file that handles all data processing in a separate thread
2. Use `requestAnimationFrame` instead of `setTimeout` for better performance and timing
3. Transfer data to the worker using efficient buffer transfers
4. Process key events and other messages in the worker and send only the results back to the main thread

Benefits of this approach:

1. **Performance:** The main UI thread remains responsive even with high data throughput
2. **Efficiency:** Using `requestAnimationFrame` synchronizes with the browser's rendering cycle
3. **Resilience:** Includes fallback to direct processing if the worker initialization fails
4. **Separation of concerns:** Clear separation between UI handling and data processing logic

This implementation ensures optimal performance while maintaining reliability for button press detection.

## Browser Compatibility

- Chrome 89 or later
- Edge 89 or later
- Opera 75 or later
- Not supported in Firefox or Safari (as of 2023)

## Deno Application for Grid Testing

This project includes a Deno application (`grid_test.ts`) that connects to a Monome Grid using the serialosc protocol.

### Features

- Uses the `@capogreco/monome-deno` JSR module for serialosc communication
- Listens for grid button presses and logs them to the console
- Lights up grid buttons to match their pressed state
- Simple API for grid interaction

### Requirements

- Deno installed on your system
- serialosc running in the background (`brew service start serialosc`)
- Monome Grid connected via USB

### Running the Application

```bash
# Start the web server for the browser application
deno task start

# Run the grid test with serialosc
deno task test
```

## CLI Serial Logger Tool

The project also includes a Python-based CLI tool (`cli/monome_logger.py`) for debugging and monitoring serial communication with Monome Grid devices.

### Features

- Monitor and log all serial communication with Monome devices
- Display decoded Monome protocol messages
- List available serial ports
- Save log files for debugging
- Display raw or formatted hexadecimal data

### Usage

See `cli/README.md` for full usage instructions and examples.

```bash
# List available serial ports
./cli/monome_logger.py -l

# Connect to a Monome Grid
./cli/monome_logger.py -p /dev/tty.usbserial-m1000065

# Display raw hex data
./cli/monome_logger.py -p /dev/tty.usbserial-m1000065 --hex
```

## Resources

- [Web Serial API Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Serial)
- [Web Audio API Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
- [Monome Grid Documentation](https://monome.org/docs/grid/)
- [Monome Serial Protocol Documentation](https://monome.org/docs/serialosc/protocol/)
- [Deno Documentation](https://deno.land/manual)
- [serialosc Documentation](https://monome.org/docs/serialosc/)
- [Python Serial Library](https://pyserial.readthedocs.io/)